# ADR-002: Secure File Upload with Magic Bytes Validation
Дата: 2025-01-22
Статус: Accepted

## Context

Reading List API требует возможность загрузки файлов (изображения обложек книг, документы) с обеспечением безопасности. Необходимо предотвратить атаки через загрузку вредоносных файлов, path traversal и обход ограничений размера.

**Угрозы:**
- Загрузка исполняемых файлов под видом изображений
- Path traversal атаки через имена файлов
- DoS атаки через большие файлы
- Симлинк атаки для доступа к системным файлам

**Ограничения:**
- Поддержка только безопасных типов файлов
- Ограничение размера файлов
- Предотвращение path traversal
- Защита от симлинков

## Decision

Реализовать безопасную загрузку файлов с валидацией magic bytes, канонизацией путей и UUID именами.

**Параметры безопасности:**
- Максимальный размер файла: 5MB
- Разрешенные типы: PNG, JPEG
- Валидация magic bytes (не только MIME type)
- UUID имена файлов (предотвращение конфликтов)
- Канонизация путей (предотвращение traversal)
- Запрет симлинков в родительских директориях

**Технические детали:**
- PNG: `\x89PNG\r\n\x1a\n`
- JPEG: `\xff\xd8` (SOI) + `\xff\xd9` (EOI)
- Базовый путь: `/app/uploads/`
- Расширение файла по типу контента

## Consequences

**Плюсы:**
- Высокий уровень безопасности загрузок
- Предотвращение основных атак через файлы
- Простота интеграции
- Соответствие security best practices

**Минусы:**
- Ограниченные типы файлов
- Дополнительная валидация (CPU)
- UUID имена (менее читаемые)

**Влияние на производительность:** Умеренное (валидация magic bytes)

## Links
- **NFR-01** (Хранение паролей): Безопасное хранение данных с использованием хеширования
- **NFR-09** (SQL Injection защита): 100% DB запросов через ORM без raw SQL
- **F3** (File upload attacks) из STRIDE.md: Загрузка вредоносных файлов
- **R4** (Path traversal) из RISKS.md: Обход ограничений доступа через path traversal
- **Поток 5** (User → File Storage): Пользователь загружает файлы
- **Поток 6** (API → File Storage): API сохраняет файлы
- tests/test_secure_coding.py::TestFileUploadSecurity
- app/core/upload.py::secure_save()
