# ADR-003: HTTP Client Security Policies
Дата: 2025-01-22
Статус: Accepted

## Context

Reading List API использует внешние HTTP клиенты для интеграции с внешними сервисами (например, получение метаданных книг, валидация ISBN). Необходимо обеспечить безопасность исходящих HTTP запросов и предотвратить атаки через внешние сервисы.

**Угрозы:**
- DoS атаки через медленные внешние сервисы
- Утечка данных через небезопасные соединения
- Атаки через поддельные сертификаты
- Resource exhaustion через неограниченные запросы

**Требования:**
- Таймауты для всех HTTP запросов
- Лимиты на размер ответов
- Валидация SSL сертификатов
- Retry политики с экспоненциальным backoff

## Decision

Реализовать строгие политики безопасности для всех HTTP клиентов в приложении.

**Параметры безопасности:**
- Connection timeout: 10 секунд
- Read timeout: 30 секунд
- Max response size: 10MB
- Max redirects: 3
- SSL verification: обязательная
- Retry policy: 3 попытки с экспоненциальным backoff (1s, 2s, 4s)

**Технические детали:**
- Использование httpx.AsyncClient с ограничениями
- Валидация URL (только HTTPS для production)
- Логирование всех исходящих запросов
- Circuit breaker для нестабильных сервисов

## Consequences

**Плюсы:**
- Защита от DoS атак через внешние сервисы
- Предотвращение утечек данных
- Улучшенная надежность интеграций
- Соответствие security best practices

**Минусы:**
- Дополнительная сложность конфигурации
- Возможные false positives при блокировке
- Необходимость настройки для каждого сервиса

**Влияние на производительность:** Минимальное (таймауты предотвращают зависания)

## Links
- **NFR-02** (JWT токены): Access token TTL ≤ 15 минут, Refresh token TTL ≤ 7 дней
- **NFR-07** (Rate Limiting): API защищен от flood атак: 100 req/min на IP, 1000 req/min на пользователя
- **F2** (External service attacks) из STRIDE.md: Атаки через внешние сервисы
- **R3** (Data leakage) из RISKS.md: Утечка данных через небезопасные соединения
- **Поток 7** (API → External Service): API обращается к внешним сервисам
- **Поток 8** (External Service → API): Внешние сервисы возвращают данные
- tests/test_secure_coding.py::TestHTTPClientSecurity
- app/core/http_client.py::SecureHTTPClient
