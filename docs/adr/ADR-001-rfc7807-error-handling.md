# ADR-001: RFC 7807 Error Handling
Дата: 2025-01-22
Статус: Accepted

## Context

Приложение Reading List API нуждается в стандартизированной обработке ошибок для улучшения отладки, мониторинга и интеграции с клиентскими приложениями. Текущая система обработки ошибок не предоставляет достаточной информации для диагностики проблем и не соответствует стандартам индустрии.

**Проблемы:**
- Отсутствие correlation_id для трассировки запросов
- Нестандартный формат ошибок
- Отсутствие маскирования чувствительных данных
- Сложность отладки в production

## Decision

Принять RFC 7807 (Problem Details for HTTP APIs) как стандарт для всех HTTP ошибок в API.

**Реализация:**
- Все ошибки возвращаются в формате JSON с полями: `type`, `title`, `status`, `detail`, `correlation_id`
- Добавление correlation_id для трассировки запросов
- Маскирование чувствительных данных в error details
- Создание карты ошибок для клиентских приложений

**Параметры:**
- Максимальная длина detail: 1000 символов
- Correlation ID: UUID4
- Тип ошибки по умолчанию: "about:blank"
- Маскирование паттернов: email, password, token, secret

## Consequences

**Плюсы:**
- Стандартизированный формат ошибок
- Улучшенная трассировка и отладка
- Лучшая интеграция с клиентскими приложениями
- Соответствие индустриальным стандартам

**Минусы:**
- Дополнительная сложность в коде
- Увеличение размера ответов
- Необходимость обновления клиентских приложений

**Влияние на производительность:** Минимальное (добавление correlation_id и форматирование)

## Links
- **NFR-04** (Структурированные ошибки): 100% API endpoints возвращают ошибки в формате RFC7807 с correlation_id
- **NFR-08** (Логирование безопасности): Все security events логируются с request_id и user_id
- **F1** (Authentication bypass) из STRIDE.md: Обход аутентификации через поддельные токены
- **R2** (Information disclosure) из RISKS.md: Утечка чувствительной информации через ошибки
- **Поток 3** (User → API): Пользователь отправляет запросы к API
- **Поток 4** (API → Database): API обращается к базе данных
- tests/test_secure_coding.py::TestRFC7807ErrorHandling
- app/core/errors.py::problem()
